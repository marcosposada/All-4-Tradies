<?php

class
MageB2B_Sublogin_FrontendController
extends
Mage_Core_Controller_Front_Action
{
public
function
preDispatch()
{
parent::preDispatch();
if
(!Mage::getSingleton('customer/session')->authenticate($this))
{
$this->setFlag('',
'no-dispatch',
true);
}
}

public
function
indexAction()
{
$this->loadLayout();
$this->getLayout()->getBlock('head')->setTitle($this->__('Further Logins'));
if
($_d1b5a9e6d88844d06736cc808299e4fce5599202
=
$this->getLayout()->getBlock('customer.account.link.back'))
{
$_d1b5a9e6d88844d06736cc808299e4fce5599202->setRefererUrl($this->_getRefererUrl());
}
$this->renderLayout();
}
public
function
createAction()
{
$this->_forward('edit');
}
public
function
editAction()
{
$_ce376578098cf70af7021fca72fe4e15a4a98365
=
$this->getRequest()->getParam('id');
$_384d479d3c396afbfb7e832d2d450608e3145d55
=
Mage::getModel('sublogin/sublogin')->load($_ce376578098cf70af7021fca72fe4e15a4a98365);
$_b803c43bc8b3ef64b7d19b78f670cdbd11dacf8c
=
Mage::getSingleton('customer/session')->getCustomer();
if
($this->hasAccess($_384d479d3c396afbfb7e832d2d450608e3145d55)
&&
($_384d479d3c396afbfb7e832d2d450608e3145d55->getId()
||
$_ce376578098cf70af7021fca72fe4e15a4a98365
==
0))
{
$_384d479d3c396afbfb7e832d2d450608e3145d55->setData('expire_date',
$this->unFormatDate($_384d479d3c396afbfb7e832d2d450608e3145d55->getData('expire_date')));
if
($this->getRequest()->isPost())
{
$_6fb02c14a9aa8279c0be3446f87b5153ed38c016
=
false;
$_02000d93f53443c66f188e6620797faaaeba5739
=
false;

$_791b80c93437c3a51c059f29b3d495ff07ca01e2
=
array('firstname',
'lastname',
'email',
'active');
$_2a145552e00905331cd502938610b699e18379e0
=
array('firstname',
'lastname',
'email');
$_da9741d865f8de50c427250ecfa2890ae98ae8d0
=
false;
if
($_ce376578098cf70af7021fca72fe4e15a4a98365
==
0)
{
$_2a145552e00905331cd502938610b699e18379e0[]
=
'password';
$_02000d93f53443c66f188e6620797faaaeba5739
=
true;
}
foreach
($_2a145552e00905331cd502938610b699e18379e0
as
$_5daa1085ee90198c9df8565a4a980ca7a8d3f105)
{
if
(!$this->getRequest()->getParam($_5daa1085ee90198c9df8565a4a980ca7a8d3f105))
{
$_da9741d865f8de50c427250ecfa2890ae98ae8d0
=
true;
Mage::getSingleton('core/session')->addError(Mage::helper('sublogin')->__('%s is required',
$this->__($_5daa1085ee90198c9df8565a4a980ca7a8d3f105)));
}
}

$_ff0a3525eb1a63ce44e7951a0b522829a4d2f607
=
$this->getRequest()->getParam('email');
if
($_384d479d3c396afbfb7e832d2d450608e3145d55->getData('email')
!=
$_ff0a3525eb1a63ce44e7951a0b522829a4d2f607)
{
if
(!Mage::helper('sublogin')->validateUniqueEmail($_ff0a3525eb1a63ce44e7951a0b522829a4d2f607,
$_b803c43bc8b3ef64b7d19b78f670cdbd11dacf8c->getWebsiteId()))
{
Mage::getSingleton('core/session')->addError(Mage::helper('sublogin')->__('Email "%s" already exists',
$_ff0a3525eb1a63ce44e7951a0b522829a4d2f607));
$_da9741d865f8de50c427250ecfa2890ae98ae8d0
=
true;
}
}
if
($_da9741d865f8de50c427250ecfa2890ae98ae8d0)
{
$this->_redirect('sublogin/frontend/edit',
array('id'=>$_384d479d3c396afbfb7e832d2d450608e3145d55->getId()));
return;
}

foreach
($_791b80c93437c3a51c059f29b3d495ff07ca01e2
as
$_5daa1085ee90198c9df8565a4a980ca7a8d3f105)
{
$_384d479d3c396afbfb7e832d2d450608e3145d55->setData($_5daa1085ee90198c9df8565a4a980ca7a8d3f105,$this->getRequest()->getParam($_5daa1085ee90198c9df8565a4a980ca7a8d3f105));
}
if
($this->getRequest()->getParam('password'))
{
$_384d479d3c396afbfb7e832d2d450608e3145d55->setData('password',
Mage::helper('core')->getHash($this->getRequest()->getParam('password'),
2));
$_6fb02c14a9aa8279c0be3446f87b5153ed38c016
=
true;
}
if
($this->getRequest()->getParam('expire_date'))
{
$_f0c57a04a51d1d900c8d28a111ab8f340a17465b
=
$this->formatDate($this->getRequest()->getParam('expire_date'));
$_384d479d3c396afbfb7e832d2d450608e3145d55->setData('expire_date',
$_f0c57a04a51d1d900c8d28a111ab8f340a17465b);
}
else
{

$_384d479d3c396afbfb7e832d2d450608e3145d55->setData('expire_date',
date('Y-m-d',
time()+60*60*24*90));
}
$_384d479d3c396afbfb7e832d2d450608e3145d55->setData('entity_id',
Mage::getSingleton('customer/session')->getData('id'));
$_384d479d3c396afbfb7e832d2d450608e3145d55->save();
Mage::getSingleton('core/session')->addSuccess(Mage::helper('sublogin')->__('Successfully saved sublogin %s',
$_384d479d3c396afbfb7e832d2d450608e3145d55->getEmail()));

if
($_6fb02c14a9aa8279c0be3446f87b5153ed38c016
||
$_02000d93f53443c66f188e6620797faaaeba5739)
{

$_384d479d3c396afbfb7e832d2d450608e3145d55->setPassword($this->getRequest()->getParam('password'));

$_384d479d3c396afbfb7e832d2d450608e3145d55->setStoreId(Mage::app()->getStore()->getId());
if
($_02000d93f53443c66f188e6620797faaaeba5739)
Mage::helper('sublogin')->sendNewSubloginEmail($_384d479d3c396afbfb7e832d2d450608e3145d55);
else
if
($_6fb02c14a9aa8279c0be3446f87b5153ed38c016)
Mage::helper('sublogin')->sendNewPasswordEmail($_384d479d3c396afbfb7e832d2d450608e3145d55);
}
$this->_redirect('sublogin/frontend/edit',
array('id'=>$_384d479d3c396afbfb7e832d2d450608e3145d55->getId()));
return;
}
Mage::register('subloginModel',
$_384d479d3c396afbfb7e832d2d450608e3145d55);
$this->loadLayout();
if
(($_384d479d3c396afbfb7e832d2d450608e3145d55->getData('id'))
==
0)
$this->getLayout()->getBlock('head')->setTitle($this->__('Further Logins'));
else
$this->getLayout()->getBlock('head')->setTitle($this->__('Edit further login'));
$this->renderLayout();
}
else
{
Mage::getSingleton('core/session')->addError(Mage::helper('sublogin')->__('Item does not exist'));
$this->_redirect('*/*/');
}
}
public
function
deleteAction()
{
$_ce376578098cf70af7021fca72fe4e15a4a98365
=
$this->getRequest()->getParam('id');
$_384d479d3c396afbfb7e832d2d450608e3145d55
=
Mage::getModel('sublogin/sublogin')->load($_ce376578098cf70af7021fca72fe4e15a4a98365);
if
(!$_384d479d3c396afbfb7e832d2d450608e3145d55->getId()
||
!$this->hasAccess($_384d479d3c396afbfb7e832d2d450608e3145d55))
{
Mage::getSingleton('core/session')->addError(Mage::helper('sublogin')->__('Item does not exist'));
$this->_redirect('*/*/');
}
else
{
$_384d479d3c396afbfb7e832d2d450608e3145d55->delete();
Mage::getSingleton('core/session')->addSuccess(Mage::helper('sublogin')->__('Deleted sublogin %s',
$_384d479d3c396afbfb7e832d2d450608e3145d55->getEmail()));
$this->_redirect('sublogin/frontend/index');
}
}

protected
function
hasAccess($_4e45fa4f3249d9c3cc1314ed89922593008cf117)
{

if
(Mage::helper('sublogin')->getCurrentSublogin())
return
false;

if
(!Mage::getSingleton('customer/session')->isLoggedIn())
return
false;

if
($_4e45fa4f3249d9c3cc1314ed89922593008cf117->getId()
&&
$_4e45fa4f3249d9c3cc1314ed89922593008cf117->getEntityId()
!=
Mage::getSingleton('customer/session')->getData('id'))
return
false;

return
true;
}


public
function
unFormatDate($_f0c57a04a51d1d900c8d28a111ab8f340a17465b)
{
if
(!$_f0c57a04a51d1d900c8d28a111ab8f340a17465b
||
$_f0c57a04a51d1d900c8d28a111ab8f340a17465b
==
1970
||
$_f0c57a04a51d1d900c8d28a111ab8f340a17465b
==
0)
return
null;
$_1a191a32c0ac6906283b33c6b98088360bf0b9ea
=
Mage::app()->getLocale()->getDateFormat(
Mage_Core_Model_Locale::FORMAT_TYPE_SHORT);
return
Mage::app()->getLocale()->date($_f0c57a04a51d1d900c8d28a111ab8f340a17465b,
Varien_Date::DATE_INTERNAL_FORMAT)->toString($_1a191a32c0ac6906283b33c6b98088360bf0b9ea);
}

public
function
formatDate($_f0c57a04a51d1d900c8d28a111ab8f340a17465b)
{
if
(empty($_f0c57a04a51d1d900c8d28a111ab8f340a17465b))
{
return
0;
}

if
(preg_match('/^[0-9]+$/',
$_f0c57a04a51d1d900c8d28a111ab8f340a17465b))
{
if
($_f0c57a04a51d1d900c8d28a111ab8f340a17465b<=0)
return
0;
$_f0c57a04a51d1d900c8d28a111ab8f340a17465b
=
new
Zend_Date((int)$_f0c57a04a51d1d900c8d28a111ab8f340a17465b);
}

else
if
(preg_match('#^\d{4}-\d{2}-\d{2}( \d{2}:\d{2}:\d{2})?$#',
$_f0c57a04a51d1d900c8d28a111ab8f340a17465b))
{
if
($_f0c57a04a51d1d900c8d28a111ab8f340a17465b<=0)
return
0;
$_bbb3c91a8584760004706197a44eb6790aba37a9
=
new
Zend_Date();
$_f0c57a04a51d1d900c8d28a111ab8f340a17465b
=
$_bbb3c91a8584760004706197a44eb6790aba37a9->setIso($_f0c57a04a51d1d900c8d28a111ab8f340a17465b);
}

else
{
$_f0c57a04a51d1d900c8d28a111ab8f340a17465b
=
Mage::app()->getLocale()->date($_f0c57a04a51d1d900c8d28a111ab8f340a17465b,
Mage::app()->getLocale()->getDateFormat(Mage_Core_Model_Locale::FORMAT_TYPE_SHORT),
null,
false
);
}

return
$_f0c57a04a51d1d900c8d28a111ab8f340a17465b->toString(Varien_Date::DATE_INTERNAL_FORMAT);
}
}
